<div class="flex flex-col w-full pl-10 pt-6 gap-3 ml-0">
    <% if (dono) { %>
    <h1 class="text-3xl font-semibold text-slate-900 dark:text-slate-100">
        Meu Perfil
    </h1>

    <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-300 pt-2 px-10">
        Sobre Mim:
    </h2>
    
    <div id="desc-view" class="w-full text-slate-700 dark:text-slate-400 px-10 max-w-5xl">
        <p class="break-words leading-tight indent-7 whitespace-pre-line">
            <%- description || "Você ainda não escreveu uma descrição." %>
        </p>
        <button type="button" onclick="toggleEdit()" class="mt-5 h-9 w-16 border-2 rounded-xl text-slate-900 dark:text-slate-200 border-slate-900 dark:border-slate-200 hover:bg-slate-300 dark:hover:bg-slate-800">
            Editar
        </button>
    </div>

    <form id="desc-form" action="/users/<%= userId %>/description" method="POST" class="hidden">
        <label for="description" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 px-3">
            Descrição:
        </label>

        <div class="w-full max-w-3xl px-3">
            <textarea name="description" id="description" maxlength="250" rows="5" class="w-full rounded-lg border-2 border-slate-900 dark:border-slate-200 bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 p-2 resize-none max-h-48 overflow-y-auto"><%= (description || "").trim() %></textarea>

        </div>
        
        <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
            <span id="charCount">0</span>/250
        </div>

        <div class="mt-2 flex gap-4">
            <button type="submit" class="h-10 w-24 border-2 rounded-xl text-slate-900 dark:text-slate-200 border-slate-900 dark:border-slate-200 hover:bg-slate-300 dark:hover:bg-slate-800">Salvar</button>
            <button type="button" onclick="toggleEdit()" class="h-10 w-24 border border-red-600 text-red-600 hover:bg-red-100 dark:hover:bg-red-800 rounded-xl">Cancelar</button>
        </div>
    </form>

    <h2 class="text-2xl font-semibold text-slate-900 dark:text-slate-300 px-10 mt-8">
        Minhas postagens:
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4 px-3">
        <% if (posts.length === 0) { %>
            <p class="text-slate-700 dark:text-slate-400 col-span-full break-words leading-tight indent-7">Você não fez nenhuma postagem.</p>
        <% } else { %>
            <% posts.forEach((post) => { %>
                <div class="bg-slate-300 dark:bg-slate-700 rounded-lg shadow-md flex flex-col justify-between p-4 h-70 w-full">
                    <a href="/posts/<%= post.ID %>">
                        <div class="flex-1">
                            <!-- Título -->
                            <div class="flex items-center justify-between mb-2">
                                <h2 class="text-lg font-bold text-gray-900 dark:text-gray-400"><%= post.TITLE %></h2>
                                <time class="tempoPost text-xs font-bold text-gray-900 dark:text-gray-400"></time>
                            </div>

                            <!-- Imagem -->
                            <div class="flex bg-slate-400 dark:bg-gray-800 h-42 rounded mb-4 justify-center items-center">
                                <img src="/uploads/<%= post.IMAGE %>" alt="Imagem do post" class="w-full h-full object-cover rounded" />
                            </div>



                         <!-- Local -->
                            <p class="text-xs flex items-center justify-between mb-2 text-gray-600 dark:text-gray-400 mt-6">
                                Último local: <%= post.LAST_KNOWN_LOCATION %>
                                <span class="inline-block px-4 rounded-full text-white font-semibold bg-blue-500"> <%= post.LOST_OR_FOUND == "found" ? "Encontrado" : "Perdido" %> </span>
                            </p>
                        </div>
                    </a>
                </div>
            <% }) %>
        <% } %>
    </div>

    <form action="/users/logout" method="POST" class="fixed bottom-19 right-40">
        <button type="submit" class="ml-4 h-10 w-20 border-2 rounded-xl text-slate-900 dark:text-slate-200 border-slate-900 dark:border-slate-200 hover:bg-slate-300 dark:hover:bg-slate-800">Logout</button>
    </form>
    



    <% } else { %>
    <h1 class="text-3xl font-semibold text-gray-500">
        Perfil de <%- username %>
    </h1>

    <h2 class="text-2xl font-semibold text-gray-500 px-3">
        Sobre <%- username %>:
    </h2>

    <div class="w-full max-w-3xl mx-auto text-gray-700 dark:text-gray-300 px-3">
        <p class="break-words leading-tight indent-7">
            <%- description || "Este usuário ainda não escreveu uma descrição." %>
        </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4 px-3">
        <% if (posts.length === 0) { %>
            <p class="text-gray-500 col-span-full">Este usuário não fez nenhuma postagem.</p>
        <% } else { %>
            <% posts.forEach(post => { %>
                <a href="/posts/<%= post.ID %>" class="block bg-slate-300 dark:bg-slate-800 rounded-lg p-4 shadow hover:bg-slate-400 dark:hover:bg-slate-700 transition">
                    <h3 class="text-xl font-bold text-gray-700 dark:text-gray-100">
                        <%= post.TITLE %>
                    </h3>
                    <img src="/uploads/<%= post.IMAGE %>" alt="Imagem do animal" class="mt-2 rounded max-h-40 object-cover w-full">
                    <p class="mt-2 text-gray-600 dark:text-gray-300 text-sm truncate">
                        <%= post.DESCRIPTION %>
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        Último local: <%= post.LAST_KNOWN_LOCATION %>
                    </p>
                </a>
            <% }) %>
        <% } %>
    </div>
</div>

    <form action="/users/<%= userId %>" method="POST" class="fixed bottom-19 right-40">
        <button type="submit" class="ml-4 h-10 w-20 border-2 rounded-xl text-slate-900 dark:text-slate-200 border-slate-900 dark:border-slate-200 hover:bg-slate-300 dark:hover:bg-slate-800">Chat</button>
    </form>
    <% } %>

<script>

    function tempoDesde(data) {
        const segundos = Math.floor((new Date() - data) / 1000);
        const intervalos = [
            { label: "ano", seg: 31536000 },
            { label: "mês", seg: 2592000 },
            { label: "dia", seg: 86400 },
            { label: "h", seg: 3600 },
            { label: "min", seg: 60 }
        ];
        for (const i of intervalos) {
            const valor = Math.floor(segundos / i.seg);
            if (valor > 0) return `há ${valor} ${i.label}`;
        }
        return "Recente";
    }

    const tempos = document.querySelectorAll(".tempoPost");
    const posts = <%- JSON.stringify(posts) %>;

    for (let i = 0; i < tempos.length; i++) {
        const dataPost = new Date(posts[i].TIMESTAMP);
        tempos[i].textContent = tempoDesde(dataPost);
    }

    function toggleEdit() {
    const view = document.getElementById('desc-view');
    const form = document.getElementById('desc-form');

    view.classList.toggle('hidden');
    form.classList.toggle('hidden');


    const textarea = document.getElementById("description");
    const count = document.getElementById("charCount");

    if (!form.classList.contains("hidden")) {
      count.textContent = textarea.value.length;

      textarea.addEventListener("input", () => {
        count.textContent = textarea.value.length;
      });
    }
  }


  document.addEventListener("DOMContentLoaded", () => {
    const textarea = document.getElementById("description");
    const count = document.getElementById("charCount");

    if (textarea && !textarea.closest("form").classList.contains("hidden")) {
      count.textContent = textarea.value.length;

      textarea.addEventListener("input", () => {
        count.textContent = textarea.value.length;
      });
    }
  });
</script>
